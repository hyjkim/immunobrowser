{% extends "base.html" %}

{% block css %}
<style type="text/css">

</style>
{% endblock %}

{% block content %}

{% load comparison_tags %}

<div class="menu sample row">
  <div id="filter-forms">
    {% if comparison %}
    {% filter_forms_tag comparison %}
    {% else %}
    No comparison
    {% endif %}
  </div>
  <div id="add-sample" class="col-md-2 text-center nav">
    <a>
      <h1>+</h1><br />
      Add sample
    </a>
  </div>
  <div id="sample-compare" class="col-md-3 nav text-right">
    {% sample_compare_tag sample_compare_form%}
  </div>
</div>


<script>
  // specific code
  {% autoescape off %}
  var comparisonId = '{{comparison.id}}';
  {% endautoescape %}

  // dashboard universal code

  var sampleCompareDiv = $('div#sample-compare');
  var addSampleDiv = $('div#add-sample');
  var sampleSubmit = $('div#sample-compare :submit');
  var sampleCancel = $('div#sample-compare :button');
  var sampleForm = $('div#sample-compare form');
  var sampleRemoveGlyphs = $('.glyphicon-remove');
  var filterForms = $('.filter-form');

  // Make sure the sample compare div is hidden
  sampleCompareDiv.hide();

  addSampleDiv.click(function () {
    sampleCompareDiv.show();
    addSampleDiv.hide();
  });

  sampleSubmit.click(function () {
    event.preventDefault();
    var postData = sampleForm.serializeArray();
    if (comparisonId) {
      postData.push({'name':'comparison', 'value': comparisonId});
    }

    sampleCompareDiv.hide();
    addSampleDiv.show();

    console.log(postData);

    $.post('{% url 'dashboard.views.add_samples_v2' %}',
    postData, function (compId) {

      // Load filter forms
      $.get("/compare/" + compId + "/filter_forms",
      function(filterForms) {
        $('div#filter-forms').html(filterForms)
        setup();
      });

      // Update global comparisonId variable
      comparisonId = compId

      // Modify url bar
      // Should modify this javascript to use 
      // a django template tag for 'dashboard.views.dashboard_v2'
      window.history.pushState(null, '', '/dashboard_v2/' + compId);
    });


  });

  sampleCancel.click(function () {
    sampleCompareDiv.hide();
    addSampleDiv.show();
  });


  var setup = function () {
    sampleRemoveGlyphs = $('.glyphicon-remove');
    sampleRemoveGlyphs.click(closeFunction);
  };

  var closeFunction = function() {
    cfId = $(this).attr('id').match(/\d+/)[0];
    postData = [{'name':'comparison', 'value': comparisonId},
    {'name':'clonofilter', 'value': cfId}];
    $.post('{% url 'dashboard.views.remove_clonofilter' %}',
    postData, function (compId) {
      comparisonId = compId;
      window.history.pushState(null, '', '/dashboard_v2/' + compId);
      // Load filter forms
      $.get("/compare/" + compId + "/filter_forms",
      function(filterForms) {
        $('div#filter-forms').html(filterForms)
        setup();
      });
    });

  };

  setup();


  // Change opacity of filter form on mouse over
  filterForms
  .on("mouseover", function () {
    $(this).removeClass("inactive").addClass("active");
  })
  .on("mouseleave", function () {
    $(this).removeClass("active").addClass("inactive");
  })
  .click(function () {
    var body = $(this).find('.accordion-body')
    if (body.length) {
      body.collapse('show')
      body.removeClass('accordion-body').addClass('accordion-body-disabled');
    }
    else {
      body = $(this).find('.accordion-body-disabled');
      body.removeClass('accordion-body-disabled').addClass('accordion-body');
      body.collapse('hide');
    }

  })
  ;



  // Hide filters after some predetermined amount of time
  setTimeout(function() {
    $('.accordion-body').collapse('hide');
  },
  1000);



</script>
{% endblock %}
