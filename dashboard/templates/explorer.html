{% extends "base.html" %}
{% block css %}
<link rel="stylesheet" href="{{ STATIC_URL }}libs/jqtree.css">
{% endblock %}
{% block content %}


<div class="row">
  <div class="span4">
    <div class="accordion" id="accordion2">
      <div class="accordion-group">
        <div class="accordion-heading">
          <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
            Sample Navigator
          </a>
        </div>
        <div id="collapseOne" class="accordion-body collapse in">
          <div class="accordion-inner">
            <div id="tree1">
              <ul>
                {% for patient in patients %}
                <li>
                <a href="{% url 'patients.views.patient_summary' patient.id %}">{{ patient }}</a>
                <input type="checkbox" id="patient_{{ patient.id }}">
                <ul>
                  {% for sample in patient.sample_set.all %}
                  <li><a href="{% url 'samples.views.summary' sample.id %} ">{{ sample }}</a>
                  <input type="checkbox" id="sample_{{ sample.id }}">
                  </li>
                  {% endfor %}
                </ul>
                </li>

                {% endfor %}
              </ul>

            </div>
            <input type="button" value="Compare">
          </div>
        </div>
      </div>
      <div class="accordion-group">
        <div class="accordion-heading">
          <a class="accordion-toggle" data-toggle="collapse"
            data-parent="#accordion2" href="#collapseTwo"
            id="filter_form_toggle">
            Samples in Comparison
          </a>
        </div>
        <div id="collapseTwo" class="accordion-body collapse">
          <div class="accordion-inner">
            <div id="filter_forms_div">
              Empty
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <div id="main" class="span8">
    Main page goes here. Explain what this thing is and what it does
  </div>
</div>

{% endblock %}

{% block site_js %}
<script type='text/javascript' src="{{ STATIC_URL }}libs/tree.jquery.js"></script>

<script>
  $(function() {


    $.getJSON(
    '{% url 'dashboard.views.menu_json' %}',
    function(data) {
      // build jqTree
      var $tree = $('#tree1');
      $tree.tree({
        data: data,
      });

      // Gets and loads a comparison id

      // submit array of primary keys to add_samples view
      $(":button").click(function() {
        $selectedNodes = $tree.tree('getSelectedNodes');
        var selectedNodeKeys = [];
        $.each($selectedNodes, function(index, node) {
          selectedNodeKeys.push(node.pk);
        });
        if (selectedNodeKeys.length  > 1) {
          console.log(JSON.stringify(selectedNodeKeys))
          $.post("{% url 'dashboard.views.add_samples' %}", {
            sample_ids: JSON.stringify(selectedNodeKeys),
            }, function(comparison_id) {
            $('div#main').html("<img src=/static/img/ajax-loader.gif>");
            $.get("/compare/" + comparison_id, function(comparison) {
              $('div#main').html(comparison)
            });
            $.get("/compare/" + comparison_id + "/filter_forms",
            function(filter_forms_html) {
              $('div#filter_forms_div').html(filter_forms_html)
            });
            $('a#filter_form_toggle').click()
            
            var stateObj = { foo: "bar" };
            console.log(stateObj);
            history.pushState(stateObj, "comparison" + comparison_id,
            "dashboard/compare/"+comparison_id);
            console.log(stateObj);

          });
        }
        else {
          alert("Please select more than one sample for comparison");
        }

      });

      // modify default tree behavior
      $tree.bind('tree.click',
      function(e) {
        e.preventDefault();
        var selected_node = e.node;

        if($tree.tree('isNodeSelected', selected_node)) {
          $tree.tree('removeFromSelection', selected_node);
        }
        else {
          if(selected_node.children.length == 0) {
            $tree.tree('addToSelection', selected_node);
          }
        }

        if(!selected_node.is_open) {
          $tree.tree('toggle', selected_node);
          $.each(selected_node.children, function(index, child_node) {
            $tree.tree('addToSelection', child_node);
          });
        }
        else {
          var num_selected_children = 0;
          $.each(selected_node.children, function(index, child_node) {
            if($tree.tree('isNodeSelected', child_node)) {
              num_selected_children++;
            }
          });
        }
        if (num_selected_children == selected_node.children.length) {
          $.each(selected_node.children, function(index, child_node) {
            $tree.tree('removeFromSelection', child_node);
          });
        }
        else {
          $.each(selected_node.children, function(index, child_node) {
            $tree.tree('addToSelection', child_node);
          });
        }
      });
      console.log(data);
    }
    );
  });
</script>
{% endblock %}
